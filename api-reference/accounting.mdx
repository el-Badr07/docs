---
title: "Accounting API Reference"
description: "Complete API reference for Textra's 5-phase accounting automation pipeline with French PCG compliance"
---

The Accounting API provides comprehensive invoice processing through a sophisticated 5-phase pipeline that transforms raw invoices into French accounting standard-compliant journal entries. The system handles both synchronous and asynchronous processing modes with intelligent caching, multi-provider LLM integration, and comprehensive monitoring capabilities.

## System Architecture

### 5-Phase Processing Pipeline

The Accounting API implements a **5-phase processing pipeline** ensuring accuracy and compliance:

1. **Phase 1 - Data Extraction**: OCR and LLM-powered structured data extraction
2. **Phase 2 - Account Imputation**: AI-driven PCG account mapping with accounts
3. **Phase 3 - Journal Generation**: French accounting standard-compliant journal entries
4. **Phase 4 - Validation**: Data validation and compliance checking
5. **Phase 5 - Export**: Multi-format export (CSV/FEC, XML, JSON, Sage)

### Core Technologies

- **Multi-Provider LLM**: Groq, Gemini, OpenAI integration with intelligent routing
- **French PCG Compliance**: Complete integration with Plan Comptable Général
- **MongoDB Persistence**: 6 core collections for comprehensive data storage
- **Redis Caching**: Multi-layer caching with adaptive TTL management
- **RabbitMQ Tasks**: Background processing with specialized queues
- **Real-time Monitoring**: Performance metrics and health checks

## Core Processing Endpoints

### Process Invoice (Synchronous)

Process a single invoice immediately with real-time response.

```http
POST /api/accounting/process-invoice
```

**Request Parameters:**
- `file` (form-data): Invoice file to process
- `export_formats` (form-data): Comma-separated export formats (default: "csv,json")
- `auto_export` (form-data): Auto-export results (default: true)
- `user_id` (form-data, optional): User ID for tracking

**Response:**
```json
{
  "invoice_id": "INV-12345678-231201",
  "processing_id": "ObjectId",
  "extraction_id": "ObjectId",
  "proposals_id": "ObjectId",
  "journal_id": "ObjectId",
  "request_info": {
    "processing_id": "ObjectId",
    "invoice_id": "INV-12345678-231201",
    "original_filename": "invoice.pdf",
    "user_id": "user123",
    "processing_mode": "synchronous",
    "timestamp": "2024-01-15T10:30:00Z"
  },
  "extracted_invoice": {
    "invoice_number": "FAC-2024-001",
    "vendor_name": "ACME Corp",
    "total_amount_ttc": 1200.00,
    "invoice_date": "2024-01-15",
    "line_items": [...]
  },
  "accounting_proposals": {
    "debit_accounts": [...],
    "credit_accounts": [...],
    "pcg_mappings": [...]
  },
  "final_journal_entry": {
    "entry_lines": [...],
    "total_debit": 1200.00,
    "total_credit": 1200.00,
    "is_balanced": true
  },
  "export_files": {
    "csv": "/storage/exports/csv/INV-12345678-231201.csv",
    "json": "/storage/exports/json/INV-12345678-231201.json"
  }
}
```

### Process Invoice (Asynchronous)

Submit an invoice for background processing.

```http
POST /api/accounting/process-invoice-async
```

**Request Parameters:**
- `file` (form-data): Invoice file to process
- `export_formats` (form-data): Comma-separated export formats
- `auto_export` (form-data): Auto-export results
- `user_id` (form-data, optional): User ID for tracking

**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "invoice_id": "INV-12345678-231201",
  "processing_id": "ObjectId",
  "status": "pending",
  "message": "Invoice processing started"
}
```

### Process Batch (Asynchronous)

Process multiple invoices in parallel.

```http
POST /api/accounting/process-batch-async
```

**Request Parameters:**
- `files` (form-data): Multiple invoice files
- `export_formats` (form-data): Export formats for all files
- `auto_export` (form-data): Auto-export all results
- `max_workers` (form-data, optional): Maximum parallel workers
- `user_id` (form-data, optional): User ID for tracking

**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440001",
  "file_count": 5,
  "processing_ids": ["ObjectId1", "ObjectId2", ...],
  "status": "pending",
  "message": "Batch processing started"
}
```

### Task Status Tracking

Monitor processing progress for asynchronous tasks.

```http
GET /api/accounting/task-status/{task_id}
```

**Response:**
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "STARTED|SUCCESS|FAILURE|PENDING",
  "result": {
    "invoice_id": "INV-12345678-231201",
    "processing_complete": true,
    "export_files": [...]
  },
  "progress": {
    "current_phase": "Phase 3 - Journal Generation",
    "completion_percentage": 75
  },
  "error": null
}
```

## Export and Download Endpoints

### Export Accounting Entry

Export processed accounting data in various formats.

```http
POST /api/accounting/export
```

**Request Body:**
```json
{
  "export_formats": ["csv", "xml", "json", "sage"],
  "base_filename": "custom_export_name",
  "user_id": "user123"
}
```

**Response:**
```json
{
  "task_id": "export-550e8400-e29b-41d4-a716-446655440002",
  "invoice_id": "INV-12345678-231201",
  "export_formats": ["csv", "xml"],
  "status": "pending",
  "message": "Export task started"
}
```

### Download Export File

Download generated export files.

```http
GET /api/accounting/download/{format}/{filename}
```

**Path Parameters:**
- `format`: Export format (csv, xml, json, sage)
- `filename`: Name of the file to download

**Response:** File download with appropriate MIME type

### Get Supported Formats

Retrieve list of available export formats.

```http
GET /api/accounting/supported-formats
```

**Response:**
```json
{
  "supported_formats": ["csv", "xml", "json", "sage"],
  "format_descriptions": {
    "csv": "Comma-separated values format",
    "xml": "XML format compatible with French accounting software",
    "json": "JSON format for API integration",
    "sage": "Sage accounting software format"
  }
}
```

## PCG (Plan Comptable Général) Integration

### Search PCG Accounts

Search through the French Chart of Accounts.

```http
GET /api/accounting/pcg-accounts?search={term}&account_class={class}&limit={limit}
```

**Query Parameters:**
- `search` (optional): Search term for account names/numbers
- `account_class` (optional): Filter by account class (1-8)
- `limit` (optional): Maximum results (default: 100)

**Response:**
```json
{
  "accounts": [
    {
      "account_number": "401000",
      "account_name": "Fournisseurs",
      "account_class": "4",
      "description": "Comptes des fournisseurs d'exploitation"
    }
  ],
  "total_found": 25,
  "search_term": "fournisseur",
  "account_class": "4"
}
```

### Validate Account Numbers

Validate account numbers against PCG standards.

```http
POST /api/accounting/validate-accounts
```

**Request Body:**
```json
["401000", "706000", "445710", "999999"]
```

**Response:**
```json
{
  "validation_results": {
    "401000": {
      "exists": true,
      "details": {
        "account_name": "Fournisseurs",
        "account_class": "4"
      },
      "valid": true
    },
    "999999": {
      "exists": false,
      "details": null,
      "valid": false
    }
  },
  "summary": {
    "total_checked": 4,
    "valid_accounts": 3,
    "invalid_accounts": 1
  }
}
```

## System Management Endpoints

### Health Check

Monitor system health and component status.

```http
GET /api/accounting/health
```

**Response:**
```json
{
  "overall_status": "healthy",
  "components": {
    "database": {
      "status": "healthy",
      "type": "MongoDB",
      "message": "Connection successful"
    },
    "cache": {
      "status": "healthy",
      "type": "Redis",
      "message": "Connection successful"
    },
    "task_queue": {
      "status": "healthy",
      "type": "RabbitMQ",
      "message": "Connection successful"
    },
    "storage": {
      "storage/uploads": {
        "status": "healthy",
        "message": "Read/write access confirmed"
      },
      "storage/exports": {
        "status": "healthy",
        "message": "Read/write access confirmed"
      }
    }
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### Performance Statistics

Retrieve processing performance metrics.

```http
GET /api/accounting/performance-stats?period_days={days}
```

**Response:**
```json
{
  "period_days": 30,
  "total_processed": 1250,
  "success_rate": 98.4,
  "average_processing_time": 12.5,
  "processing_times": {
    "extraction": 3.2,
    "imputation": 4.1,
    "journal_generation": 3.8,
    "export": 1.4
  },
  "error_counts": {
    "OCR extraction failed": 8,
    "Invalid PCG account": 3,
    "Balance validation error": 2
  },
  "daily_volumes": [
    {"date": "2024-01-14", "count": 45},
    {"date": "2024-01-13", "count": 38}
  ]
}
```

### Cache Management

Monitor and control Redis cache status.

```http
GET /api/accounting/cache-status
```

**Response:**
```json
{
  "status": "connected",
  "cache_keys": {
    "invoice_all": 234,
    "extraction_all": 189,
    "proposals_all": 156,
    "journal_all": 143,
    "task_all": 67
  },
  "memory": {
    "used_memory_human": "45.2M",
    "used_memory_peak_human": "52.1M",
    "total_system_memory_human": "16.0G"
  },
  "uptime_in_seconds": 86400,
  "connected_clients": 8
}
```

Clear specific cache types:

```http
POST /api/accounting/clear-cache
```

**Request Body:**
```json
{
  "cache_type": "invoices|tasks|llm|stats|reports|all"
}
```

### Database Status

Monitor MongoDB database health and statistics.

```http
GET /api/accounting/database-status
```

**Response:**
```json
{
  "status": "connected",
  "uptime_seconds": 3600000,
  "version": "6.0.2",
  "connections": 12,
  "collection_counts": {
    "processed_invoices": 1250,
    "extraction_data": 1250,
    "accounting_proposals": 1180,
    "journal_entries": 1150,
    "enhanced_journal_entries": 1150,
    "processing_metrics": 1250
  },
  "recent_counts": {
    "processed_invoices_24h": 45,
    "extraction_data_24h": 45,
    "journal_entries_24h": 42
  }
}
```

## Reporting Endpoints

### Monthly Accounting Report

Generate comprehensive monthly accounting reports.

```http
GET /api/accounting/monthly-report/{year}/{month}?skip_cache={boolean}
```

**Response:**
```json
{
  "year": 2024,
  "month": 1,
  "total_entries": 125,
  "total_debit": 150000.00,
  "total_credit": 150000.00,
  "balance_difference": 0.00,
  "balanced_entries": 123,
  "balanced_percentage": 98.4,
  "unique_accounts": 45,
  "vendor_statistics": [
    {"name": "ACME Corp", "count": 15},
    {"name": "Beta Industries", "count": 12}
  ],
  "entries_data": [
    {
      "id": "ObjectId",
      "invoice_id": "INV-12345678-231201",
      "invoice_number": "FAC-2024-001",
      "vendor": "ACME Corp",
      "invoice_date": "2024-01-15",
      "due_date": "2024-02-15",
      "status": "pending",
      "category": "services",
      "total_amount": 1200.00,
      "tax_amount": 240.00,
      "confidence": 0.95,
      "notes": "IT consulting services"
    }
  ]
}
```

### Yearly Accounting Report

Generate comprehensive yearly accounting reports.

```http
GET /api/accounting/yearly-report/{year}?skip_cache={boolean}
```

### Date Range Report

Generate reports for custom date ranges.

```http
GET /api/accounting/date-range-report/{start_year}/{start_month}/{end_year}/{end_month}?skip_cache={boolean}
```

## Invoice Management Endpoints

### Get All Accounting Entries

Retrieve paginated list of all accounting entries.

```http
GET /api/accounting/accounting-entries?limit={limit}&skip={skip}&sort_by={field}&sort_order={order}
```

**Response:**
```json
{
  "total_count": 1250,
  "limit": 100,
  "skip": 0,
  "entries": [
    {
      "id": "ObjectId",
      "invoice_id": "INV-12345678-231201",
      "invoice_number": "FAC-2024-001",
      "vendor": "ACME Corp",
      "total_amount": 1200.00,
      "is_balanced": true,
      "created_at": "2024-01-15T10:30:00Z",
      "line_count": 4
    }
  ]
}
```

### Get Specific Accounting Entry

Retrieve detailed information for a specific entry.

```http
GET /api/accounting/accounting-entry/{entry_id}?skip_cache={boolean}
```

### Update Accounting Entry

Update accounting entry information.

```http
PUT /api/accounting/accounting-entry/{entry_id}
```

**Request Body:**
```json
{
  "enhanced_journal_entry": {
    "original_invoice": {
      "vendor_name": "Updated Vendor Name",
      "due_date": "2024-03-15",
      "status": "paid"
    }
  },
  "total_debit": 1200.00,
  "total_credit": 1200.00,
  "is_balanced": true
}
```

### Update Entry Status

Update the status of an accounting entry.

```http
PATCH /api/accounting/accounting-entry/{entry_id}/status
```

**Request Body:**
```json
{
  "status": "approved|rejected|posted|archived"
}
```

## Invoice Generation Endpoints

### Generate Invoice from Structured Data

Create new invoices with structured data input.

```http
POST /api/accounting/generate-invoice
```

**Request Body:**
```json
{
  "vendor_name": "ACME Corp",
  "customer_name": "Beta Industries",
  "invoice_date": "2024-01-15",
  "items": [
    {
      "description": "IT Consulting Services",
      "quantity": 10,
      "unit_price": 100.00,
      "amount": 1000.00
    }
  ],
  "invoice_number": "FAC-2024-001",
  "total_amount": 1200.00,
  "currency": "EUR",
  "payment_terms": "Net 30",
  "tax_rate": 20.0,
  "tax_amount": 200.00,
  "status": "pending"
}
```

### Generate Invoice from Natural Language

Create invoices using natural language descriptions.

```http
POST /api/accounting/generate-invoice-nl
```

**Request Body:**
```json
{
  "description": "Create an invoice from ACME Corp to Beta Industries for IT consulting services worth €1200 including 20% VAT, due in 30 days"
}
```

### Update Generated Invoice

Modify previously generated invoices.

```http
PUT /api/accounting/generated-invoice/{invoice_id}
```

**Request Body:**
```json
{
  "metadata": {
    "vendor_name": "Updated Vendor",
    "due_date": "2024-03-15",
    "total_amount": 1300.00
  },
  "categorization": {
    "category_name": "consulting",
    "category_code": "CONS001"
  }
}
```

## Payment Management Endpoints

### Update Payment Status

Record payment information for invoices.

```http
PUT /api/accounting/invoices/{invoice_id}/payment-status
```

**Request Body:**
```json
{
  "payment_status": "paid|pending|in_process|overdue",
  "payment_method": "bank_transfer|credit_card|cash|check",
  "payment_date": "2024-01-20",
  "paid_amount": 1200.00,
  "payment_reference": "TXN-12345",
  "payment_notes": "Payment received via bank transfer"
}
```

### Generate Financial Journal

Create banking journal entries for payments.

```http
POST /api/accounting/invoices/{invoice_id}/generate-financial-journal
```

**Request Body:**
```json
{
  "journal_type": "bank|cash|operations",
  "force_regenerate": false,
  "custom_accounts": {
    "bank_account": "512000",
    "cash_account": "531000",
    "operations_account": "512000"
  }
}
```

**Response:**
```json
{
  "success": true,
  "invoice_id": "INV-12345678-231201",
  "message": "Financial journal entry generated successfully",
  "journal_entries": [
    {
      "journal_type": "bank",
      "entries": [
        {
          "account_number": "401ACME",
          "account_name": "Fournisseur - ACME Corp",
          "debit": 1200.00,
          "credit": 0,
          "description": "Règlement facture FAC-2024-001"
        },
        {
          "account_number": "512000",
          "account_name": "Banque",
          "debit": 0,
          "credit": 1200.00,
          "description": "Règlement par bank_transfer"
        }
      ],
      "total_debit": 1200.00,
      "total_credit": 1200.00,
      "is_balanced": true
    }
  ]
}
```

### Get Banking Journal

Retrieve existing banking journal entries.

```http
GET /api/accounting/invoices/{invoice_id}/banking-journal
```

### Get Payment Options

Retrieve available payment methods and statuses.

```http
GET /api/accounting/payment-options
```

**Response:**
```json
{
  "payment_statuses": ["pending", "paid", "in_process", "overdue"],
  "payment_methods": ["bank_transfer", "credit_card", "cash", "check", "wire_transfer"]
}
```

## Bulk Operations

### Bulk Status Update

Update status for multiple invoices simultaneously.

```http
POST /api/accounting/bulk-operations/status
```

**Request Body:**
```json
{
  "invoice_ids": ["INV-001", "INV-002", "INV-003"],
  "status": "paid|pending|overdue|archived"
}
```

### Bulk Category Update

Update category for multiple invoices.

```http
POST /api/accounting/bulk-operations/category
```

### Bulk Export

Export multiple invoices in batch.

```http
POST /api/accounting/bulk-operations/export
```

**Request Body:**
```json
{
  "invoice_ids": ["INV-001", "INV-002"],
  "format": "csv|excel|json",
  "include_fields": ["invoice_number", "vendor", "total_amount"]
}
```

### Bulk Delete

Delete multiple invoices and associated data.

```http
DELETE /api/accounting/bulk-operations/delete
```

**Request Body:**
```json
{
  "invoice_ids": ["INV-001", "INV-002"],
  "confirm": true
}
```

## Get All Invoices

Retrieve comprehensive invoice data for frontend display.

```http
GET /api/accounting/invoices?limit={limit}&skip={skip}&sort_by={field}&sort_order={order}&include_extraction_data={boolean}
```

**Response:**
```json
{
  "invoices": [
    {
      "id": "ObjectId",
      "invoice_id": "INV-12345678-231201",
      "enhanced_journal_entry": {...},
      "total_debit": 1200.00,
      "total_credit": 1200.00,
      "is_balanced": true,
      "line_count": 4,
      "created_at": "2024-01-15T10:30:00Z",
      "extraction_data": {
        "extracted_invoice": {
          "invoice_number": "FAC-2024-001",
          "vendor_name": "ACME Corp",
          "total_amount_ttc": 1200.00,
          "line_items": [...]
        }
      }
    }
  ],
  "total_count": 1250,
  "returned_count": 100
}
```

## Error Handling

The API uses standard HTTP status codes and returns detailed error information:

```json
{
  "detail": "Error message describing what went wrong",
  "error_code": "PROCESSING_FAILED",
  "timestamp": "2024-01-15T10:30:00Z",
  "invoice_id": "INV-12345678-231201",
  "phase": "Phase 2 - Account Imputation"
}
```

## Rate Limiting

The API implements intelligent rate limiting based on:
- Processing complexity (simple invoices: 100/hour, complex: 50/hour)
- User tier (basic: 500/day, premium: 2000/day, enterprise: unlimited)
- Resource availability (dynamic scaling based on system load)

## Authentication

All endpoints require JWT authentication:

```http
Authorization: Bearer <jwt_token>
```

The API supports role-based access control with different permission levels for viewing, processing, and administrative operations. 