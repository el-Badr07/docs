---
title: "Voice API Reference"
description: "Complete API reference for Textra's voice interaction capabilities using LiveKit for real-time conversations with AI agents"
---

The Voice API enables real-time voice conversations with Textra's AI agents through LiveKit integration, providing natural language interaction for accounting workflows. Users can speak directly to the system to query invoices, get financial analysis, and manage accounting data through voice commands while receiving spoken responses.

## System Architecture

### LiveKit Integration

The Voice API is built on **LiveKit**, a powerful real-time communication platform that provides:

- **Real-Time Audio Processing**: Low-latency voice communication
- **WebRTC Support**: Browser-based voice interaction without plugins
- **Scalable Infrastructure**: Support for multiple concurrent voice sessions
- **Cross-Platform Compatibility**: Works across desktop, mobile, and web platforms

### Voice Processing Pipeline

The voice interaction follows a sophisticated processing pipeline:

1. **Speech-to-Text**: Convert user speech to text using advanced STT models
2. **Intent Recognition**: Understand user intent and extract parameters
3. **Agent Routing**: Route queries to appropriate AI agents
4. **Response Generation**: Generate intelligent responses using LLMs
5. **Text-to-Speech**: Convert responses back to natural speech
6. **Audio Streaming**: Stream audio responses in real-time

---

## Connection Management

### Get Voice Connection Details

Generate LiveKit connection details for voice chat. Creates a unique room and JWT token for the user.

```http
POST /api/voice/connection-details
```

**Request Body:**
```json
{
  "user_id": "user-123",
  "conversation_id": "conv-uuid-456",
  "accounting_context": {
    "invoice_count": 15,
    "vendor_count": 8,
    "category_count": 12
  }
}
```

**Response:**
```json
{
  "server_url": "ws://localhost:7880",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "participant_name": "user-user-123",
  "room_name": "textra-voice-user-123-1703760000",
  "expires_at": "2023-12-01T16:30:00Z"
}
```

**Request Model:**
- `user_id` (string, required): Unique identifier for the user
- `conversation_id` (string, optional): Associated conversation ID
- `accounting_context` (object, optional): Additional accounting context data

**Response Model:**
- `server_url` (string): LiveKit server URL for connection
- `token` (string): JWT access token for LiveKit room
- `participant_name` (string): Generated participant identifier
- `room_name` (string): Unique room name for this session
- `expires_at` (datetime): Token expiration timestamp

### Get Active Rooms

Retrieve list of active voice rooms.

```http
GET /api/voice/rooms
```

**Response:**
```json
{
  "active_rooms": [],
  "message": "Room listing requires LiveKit server API integration"
}
```

*Note: This endpoint currently returns a placeholder response. Full implementation requires LiveKit server API integration.*

### End Voice Session

End a voice session by closing the room.

```http
DELETE /api/voice/rooms/{room_name}
```

**Path Parameters:**
- `room_name` (string): Name of the room to close

**Response:**
```json
{
  "message": "Voice session ended for room textra-voice-user-123-1703760000",
  "room_name": "textra-voice-user-123-1703760000",
  "ended_at": "2023-12-01T11:00:00Z"
}
```

---

## Agent Status and Configuration

### Get Voice Agent Status

Get voice agent status and configuration details.

```http
GET /api/voice/agent/status
```

**Response:**
```json
{
  "status": "configured",
  "configuration": {
    "livekit_url": "ws://localhost:7880",
    "api_key_configured": true,
    "api_secret_configured": true
  },
  "dependencies": {
    "groq_configured": true,
    "cartesia_configured": false,
    "livekit_server_accessible": false
  },
  "timestamp": "2023-12-01T10:30:00Z"
}
```

**Response Fields:**
- `status`: Overall configuration status ("configured" or "needs_configuration")
- `configuration`: LiveKit connection configuration status
- `dependencies`: External service dependencies status
- `timestamp`: Status check timestamp

---

## Health Check

### Voice Service Health

Check the health status of the voice API service.

```http
GET /api/voice/health
```

**Response:**
```json
{
  "status": "healthy",
  "service": "voice_api",
  "timestamp": "2023-12-01T10:30:00Z",
  "livekit_configured": true
}
```

---

## Environment Configuration

### Required Environment Variables

The Voice API requires the following environment variables for proper operation:

```bash
# LiveKit Configuration
LIVEKIT_URL=ws://localhost:7880
LIVEKIT_API_KEY=your_livekit_api_key
LIVEKIT_API_SECRET=your_livekit_api_secret

# Voice Processing Dependencies
GROQ_API_KEY=your_groq_api_key
CARTESIA_API_KEY=your_cartesia_api_key
```

### LiveKit Room Configuration

When creating voice sessions, the system automatically configures:

- **Room Naming**: Format `textra-voice-{user_id}-{timestamp}`
- **Participant Naming**: Format `user-{user_id}`
- **Token Duration**: 6 hours by default
- **Permissions**: Full audio publish/subscribe, data channel access

### Accounting Context Integration

The voice API integrates with the accounting system to provide context-aware responses:

```javascript
// Example accounting context structure
{
  "status": "simplified",
  "invoice_count": 25,
  "vendor_count": 12,
  "category_count": 8,
  "pcg_available": "true",
  "chart_of_accounts_available": true
}
```

This context is used by voice agents to provide relevant responses about:
- Available invoice data
- Vendor information
- Account categories
- French PCG (Plan Comptable Général) integration

---

## Integration with LiveKit Frontend

### Client-Side Connection

Use the connection details to establish a LiveKit client connection:

```javascript
import { Room, RoomEvent } from 'livekit-client';

// Get connection details from API
const response = await fetch('/api/voice/connection-details', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    user_id: 'user-123',
    conversation_id: 'conv-456'
  })
});

const { server_url, token, room_name } = await response.json();

// Connect to LiveKit room
const room = new Room();
await room.connect(server_url, token);

// Handle voice events
room.on(RoomEvent.Connected, () => {
  console.log('Connected to voice session');
});
```

### Voice Agent Integration

The voice API works seamlessly with the LiveKit agent system running in the `livekit_agent/` directory, providing:

- **Agno Agent Integration**: Multi-agent system with specialized accounting agents
- **Memory Persistence**: MongoDB-based conversation memory
- **Knowledge Base**: PDF document integration for context-aware responses
- **Real-time Streaming**: Live audio processing and response generation

---

## Error Handling

### Common Error Responses

```json
// Invalid user or missing parameters
{
  "detail": "Failed to create voice connection: User validation failed"
}

// LiveKit configuration issues
{
  "detail": "Failed to create voice connection: LiveKit credentials not configured"
}

// Room management errors
{
  "detail": "Failed to end voice session: Room not found"
}
```

### Status Codes

- `200`: Successful operation
- `400`: Bad request (invalid parameters)
- `404`: Resource not found (room, user)
- `500`: Internal server error (configuration, LiveKit issues)

---
